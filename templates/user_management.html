{% extends "base.html" %}

<style>
/* Enhanced User Card Design */
.user-card,
div.card.user-card {
    border: 3px solid red !important;
    border-radius: 16px !important;
    background: linear-gradient(145deg, #f0f4ff 0%, #e8ecff 100%) !important;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2), 0 1px 8px rgba(0, 0, 0, 0.06) !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
    min-height: 380px !important;
}

.user-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    opacity: 0;
    transition: opacity 0.3s ease, height 0.3s ease;
    border-radius: 16px 16px 0 0;
}

.user-card::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.03) 0%, transparent 70%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.user-card:hover {
    transform: translateY(-8px) !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 2px 10px rgba(0, 0, 0, 0.1) !important;
}

.user-card:hover::before {
    opacity: 1;
    height: 6px;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.6), 0 0 40px rgba(102, 126, 234, 0.4);
}

.user-card:hover::after {
    opacity: 1;
}

.card-profile-section {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%) !important;
    border-bottom: 1px solid rgba(102, 126, 234, 0.1) !important;
    padding: 1.5rem 1rem !important;
    max-height: 120px !important;
    flex-shrink: 0;
    position: relative;
}

.card-profile-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23667eea' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.5;
    pointer-events: none;
}

.card-profile-section::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.user-avatar {
    width: 70px !important;
    height: 70px !important;
    margin: 0 auto;
    position: relative;
    overflow: hidden !important;
    flex-shrink: 0;
}

/* More specific avatar styles to override any global styles */
.user-card .user-avatar .avatar-img,
.user-card .user-avatar img {
    width: 70px !important;
    height: 70px !important;
    max-width: 70px !important;
    max-height: 70px !important;
    border-radius: 50% !important;
    object-fit: cover !important;
    border: 3px solid white;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease;
    display: block !important;
    flex-shrink: 0;
}

.user-card .user-avatar .avatar-img:hover,
.user-card .user-avatar img:hover {
    transform: scale(1.05);
}

.user-card .user-avatar .avatar-placeholder {
    width: 70px !important;
    height: 70px !important;
    max-width: 70px !important;
    max-height: 70px !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex !important;
    align-items: center;
    justify-content: center;
    border: 3px solid white;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease;
    flex-shrink: 0;
}

.user-card .user-avatar .avatar-placeholder:hover {
    transform: scale(1.05);
}

.avatar-initial {
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
}

.detail-item {
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
    padding: 0.25rem 0;
    border-radius: 6px;
}

.detail-item:hover {
    transform: translateX(3px);
    background: rgba(102, 126, 234, 0.05);
}

.detail-item i {
    color: #667eea;
    font-size: 0.9rem;
    margin-right: 0.5rem;
    width: 16px;
}

.detail-item small {
    color: #495057;
    font-weight: 500;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .user-avatar {
        width: 60px;
        height: 60px;
    }
    
    .avatar-img,
    .avatar-placeholder {
        width: 60px !important;
        height: 60px !important;
        font-size: 1.2rem;
    }
}

.user-card .btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border-radius: 10px !important;
    font-weight: 600 !important;
    position: relative;
    overflow: hidden;
    border: 2px solid transparent !important;
    backdrop-filter: blur(5px) !important;
}

.user-card .btn-outline-info {
    background: rgba(13, 202, 240, 0.1) !important;
    border-color: rgba(13, 202, 240, 0.3) !important;
    color: #0dcaf0 !important;
}

.user-card .btn-outline-info:hover {
    background: linear-gradient(135deg, #0dcaf0 0%, #0b8ca8 100%) !important;
    border-color: #0dcaf0 !important;
    color: white !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(13, 202, 240, 0.3) !important;
}

.user-card .btn-outline-warning {
    background: rgba(255, 193, 7, 0.1) !important;
    border-color: rgba(255, 193, 7, 0.3) !important;
    color: #ffc107 !important;
}

.user-card .btn-outline-warning:hover {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
    border-color: #ffc107 !important;
    color: white !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3) !important;
}

.user-card .btn-outline-danger {
    background: rgba(220, 53, 69, 0.1) !important;
    border-color: rgba(220, 53, 69, 0.3) !important;
    color: #dc3545 !important;
}

.user-card .btn-outline-danger:hover {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
    border-color: #dc3545 !important;
    color: white !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3) !important;
}

.user-card .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
}

.user-card .btn-outline-info:hover {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    border-color: #17a2b8;
}

.user-card .btn-outline-primary:hover {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-color: #007bff;
}

.user-card .btn-outline-danger:hover {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border-color: #dc3545;
}

.user-card .btn-warning:hover {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    border-color: #ffc107;
}

.user-card .btn-success:hover {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%);
    border-color: #28a745;
}

/* Status Indicator Styles */
.status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem;
    background: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    border: 2px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-dot {
    width: 16px !important;
    height: 16px !important;
    border-radius: 50%;
    transition: all 0.3s ease;
    cursor: pointer;
    display: block !important;
}

.status-dot.active {
    background-color: #28a745 !important;
    box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.3) !important;
    animation: pulse-green 2s infinite;
}

.status-dot.inactive {
    background-color: #6c757d !important;
    box-shadow: 0 0 0 4px rgba(108, 117, 125, 0.2) !important;
}

.status-dot:hover {
    transform: scale(1.2);
}

@keyframes pulse-green {
    0% {
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
    }
    50% {
        box-shadow: 0 0 0 6px rgba(40, 167, 69, 0.1);
    }
    100% {
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .user-card {
        margin-bottom: 1rem;
    }
    
    .user-avatar {
        width: 60px;
        height: 60px;
    }
    
    .avatar-img,
    .avatar-placeholder {
        width: 60px;
        height: 60px;
    }
    
    .avatar-initial {
        font-size: 1.2rem;
    }
}

/* Enhanced Card Body and Footer Design */
.user-card .card-body,
div.card.user-card .card-body {
    padding: 1.25rem !important;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.95) 100%) !important;
    backdrop-filter: blur(10px) !important;
    position: relative;
}

.user-card .card-body::before,
div.card.user-card .card-body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23667eea' fill-opacity='0.02'%3E%3Cpath d='M20 20c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10zm10 0c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.3;
    pointer-events: none;
}

.user-card .card-footer,
div.card.user-card .card-footer {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
    border-top: 1px solid rgba(102, 126, 234, 0.08) !important;
    padding: 1rem !important;
    border-radius: 0 0 16px 16px !important;
    position: relative;
}

.user-card .card-footer::before,
div.card.user-card .card-footer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23667eea' fill-opacity='0.02'%3E%3Cpath d='M10 10c0-2.76-2.24-5-5-5s-5 2.24-5 5 2.24 5 5 5 5-2.24 5-5zm10 0c0-2.76-2.24-5-5-5s-5 2.24-5 5 2.24 5 5 5 5-2.24 5-5z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.4;
    pointer-events: none;
}

.user-card .card-title {
    font-weight: 700 !important;
    color: #2c3e50 !important;
    margin-bottom: 0.25rem !important;
    font-size: 1.1rem !important;
}

.user-card .text-muted {
    color: #6c757d !important;
    font-size: 0.85rem !important;
    font-weight: 500 !important;
}

/* Animation keyframes */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <h2 class="mb-0">User Management</h2>
            <div class="text-muted small">Manage resident and admin accounts, roles, and access.</div>
        </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
            <i class="bi bi-person-plus"></i>
            <span class="ms-1">Add User</span>
        </button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="text-muted small">Total Users</div>
                    <div class="fs-4 fw-semibold">{{ stats.total_users }}</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="text-muted small">Active Users</div>
                    <div class="fs-4 fw-semibold">{{ stats.active_users }}</div>
                    <div class="text-muted small">Inactive: {{ stats.inactive_users }}</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="text-muted small">By Role</div>
                    <div class="d-flex justify-content-between">
                        <span class="small">Admins</span>
                        <span class="fw-semibold">{{ stats.admins }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="small">Residents</span>
                        <span class="fw-semibold">{{ stats.residents }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <div class="text-muted small">New in Last 30 Days</div>
                    <div class="fs-4 fw-semibold">{{ stats.new_this_month }}</div>
                </div>
            </div>
        </div>
        {% if pagination.total_pages > 1 %}
        <div class="card-footer bg-white border-0 pt-3 pb-2">
            <nav aria-label="User pagination">
                <ul class="pagination pagination-sm mb-0 justify-content-end">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link"
                           href="{% if pagination.has_prev %}{{ url_for('user_management', page=pagination.page-1, search=filters.search, role=filters.role, status=filters.status, sort=filters.sort) }}{% else %}#{% endif %}">
                            Previous
                        </a>
                    </li>
                    {% for p in range(1, pagination.total_pages + 1) %}
                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                            <a class="page-link"
                               href="{{ url_for('user_management', page=p, search=filters.search, role=filters.role, status=filters.status, sort=filters.sort) }}">{{ p }}</a>
                        </li>
                    {% endfor %}
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link"
                           href="{% if pagination.has_next %}{{ url_for('user_management', page=pagination.page+1, search=filters.search, role=filters.role, status=filters.status, sort=filters.sort) }}{% else %}#{% endif %}">
                            Next
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    <form class="card mb-4 shadow-sm border-0" method="get">
        <div class="card-body row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label mb-1">Search</label>
                <input type="text" name="search" class="form-control" placeholder="Name, email, username"
                       value="{{ filters.search }}">
            </div>
            <div class="col-md-2">
                <label class="form-label mb-1">Role</label>
                <select name="role" class="form-select">
                    <option value="all" {% if filters.role == 'all' %}selected{% endif %}>All roles</option>
                    <option value="admin" {% if filters.role == 'admin' %}selected{% endif %}>Admin</option>
                    <option value="resident" {% if filters.role == 'resident' %}selected{% endif %}>Resident</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label mb-1">Status</label>
                <select name="status" class="form-select">
                    <option value="all" {% if filters.status == 'all' %}selected{% endif %}>All</option>
                    <option value="active" {% if filters.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if filters.status == 'inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label mb-1">Sort by</label>
                <select name="sort" class="form-select">
                    <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="oldest" {% if filters.sort == 'oldest' %}selected{% endif %}>Oldest</option>
                    <option value="name" {% if filters.sort == 'name' %}selected{% endif %}>Name</option>
                    <option value="recent_login" {% if filters.sort == 'recent_login' %}selected{% endif %}>Recent login</option>
                </select>
            </div>
            <div class="col-md-2 text-md-end">
                <button type="submit" class="btn btn-outline-primary w-100">
                    <i class="bi bi-funnel"></i>
                    <span class="ms-1">Apply Filters</span>
                </button>
            </div>
        </div>
    </form>

    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
        <div class="text-muted small">
            Showing {{ pagination.total_filtered }} user{{ pagination.total_filtered != 1 and 's' or '' }}
        </div>
        <div class="btn-group">
            <a class="btn btn-sm btn-outline-secondary"
               href="{{ url_for('export_users_csv', search=filters.search, role=filters.role, status=filters.status, sort=filters.sort) }}">
                <i class="bi bi-download"></i>
                <span class="ms-1">Export CSV</span>
            </a>
            <a class="btn btn-sm btn-outline-secondary" target="_blank"
               href="{{ url_for('user_management_print', search=filters.search, role=filters.role, status=filters.status, sort=filters.sort) }}">
                <i class="bi bi-printer"></i>
                <span class="ms-1">Print View</span>
            </a>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-2" id="userCardWrapper">
            <div class="row g-3" id="userCardContainer">
                {% if users %}
                    {% for user in users %}
                        <div class="col-12 col-sm-6 col-lg-4">
                            <div class="card user-card h-100" data-user-id="{{ user.id }}" 
     style="border: none !important; border-radius: 16px !important; background: linear-gradient(145deg, #f0f4ff 0%, #e8ecff 100%) !important; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2), 0 1px 8px rgba(0, 0, 0, 0.06) !important; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important; position: relative; overflow: hidden;"
     onmouseover="this.style.boxShadow='0 20px 40px rgba(0, 0, 0, 0.15), 0 2px 10px rgba(0, 0, 0, 0.1), 0 0 30px rgba(102, 126, 234, 0.8) !important'; this.style.transform='translateY(-8px) scale(1.02) !important'; this.querySelector('.glow-bar').style.opacity='1'; this.querySelector('.glow-bar').style.height='6px';"
     onmouseout="this.style.boxShadow='0 10px 30px rgba(102, 126, 234, 0.2), 0 1px 8px rgba(0, 0, 0, 0.06) !important'; this.style.transform='translateY(0) scale(1) !important'; this.querySelector('.glow-bar').style.opacity='0'; this.querySelector('.glow-bar').style.height='4px';">
    <div class="glow-bar" style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%); opacity: 0; transition: all 0.3s ease; border-radius: 16px 16px 0 0; box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);"></div>
                                <!-- Profile Picture Section -->
                                <div class="card-profile-section text-center p-1 border-bottom" style="padding: 8px !important;">
                                    <div class="user-avatar mb-1" style="margin-bottom: 4px !important;">
                                        {% if user.profile_picture %}
                                            <img src="{{ url_for('static', filename='uploads/profile_pics/' + user.profile_picture) }}" 
                                                 alt="{{ user.first_name }} {{ user.last_name }}" 
                                                 class="avatar-img"
                                                 style="width: 50px !important; height: 50px !important; border-radius: 50% !important; object-fit: cover !important; max-width: 50px !important; max-height: 50px !important;">
                                        {% else %}
                                            <img src="{{ url_for('static', filename='img/default_profile.png') }}" 
                                                 alt="{{ user.first_name }} {{ user.last_name }}" 
                                                 class="avatar-img"
                                                 style="width: 50px !important; height: 50px !important; border-radius: 50% !important; object-fit: cover !important; max-width: 50px !important; max-height: 50px !important;">
                                        {% endif %}
                                    </div>
                                    <h6 class="card-title mb-1">{{ user.first_name }} {{ user.last_name }}</h6>
                                    <p class="text-muted small mb-0">@{{ user.username }}</p>
                                </div>
                                
                                <!-- User Details Section -->
                                <div class="card-body p-2" style="padding: 8px !important;">
                                    <div class="user-details mb-3">
                                        <div class="detail-item mb-2">
                                            <i class="bi bi-envelope text-muted me-2"></i>
                                            <span class="small">{{ user.email }}</span>
                                        </div>
                                        {% if user.phone %}
                                            <div class="detail-item mb-2">
                                                <i class="bi bi-telephone text-muted me-2"></i>
                                                <span class="small">{{ user.phone }}</span>
                                            </div>
                                        {% endif %}
                                        <div class="detail-item mb-2">
                                            <i class="bi bi-shield text-muted me-2"></i>
                                            {% if user.user_type == 'admin' %}
                                                <span class="badge bg-danger">Admin</span>
                                            {% else %}
                                                <span class="badge bg-primary">Resident</span>
                                            {% endif %}
                                        </div>
                                        <!-- Active Status Indicator -->
                                        <div class="detail-item mb-2">
                                            <i class="bi bi-circle text-muted me-2"></i>
                                            {% if user.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                            {% endif %}
                                        </div>
                                        <div class="detail-item mb-2">
                                            <i class="bi bi-activity text-muted me-2"></i>
                                            <small class="text-muted">Status: {{ user.is_active|title }}</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Additional Info -->
                                    <div class="additional-info text-muted small mb-3">
                                        <div class="mb-1">
                                            <i class="bi bi-calendar-plus me-1"></i>
                                            Created: {% if user.created_at %}{{ user.created_at }}{% else %}N/A{% endif %}
                                        </div>
                                        {% if user.last_login %}
                                            <div>
                                                <i class="bi bi-clock-history me-1"></i>
                                                Last login: {{ user.last_login }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Actions Section -->
                                <div class="card-footer bg-transparent p-2" style="padding: 8px !important;">
                                    <div class="d-flex gap-2 justify-content-center flex-wrap align-items-center">
                                        <!-- Active Status Indicator -->
                                        <div class="status-indicator">
                                            {% if user.is_active %}
                                                <span class="status-dot active" title="Active"></span>
                                            {% else %}
                                                <span class="status-dot inactive" title="Inactive"></span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Edit Button -->
                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editUserModal"
                                                data-user-id="{{ user.id }}"
                                                data-first-name="{{ user.first_name }}"
                                                data-last-name="{{ user.last_name }}"
                                                data-username="{{ user.username }}"
                                                data-email="{{ user.email }}"
                                                data-user-type="{{ user.user_type }}"
                                                data-is-active="{{ user.is_active }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        
                                        <!-- View Button -->
                                        <button class="btn btn-sm btn-outline-info" 
        data-bs-toggle="modal" 
        data-bs-target="#viewUserModal"
        data-user-id="{{ user.id }}"
        data-first-name="{{ user.first_name }}"
        data-last-name="{{ user.last_name }}"
        data-username="{{ user.username }}"
        data-email="{{ user.email }}"
        data-address="{{ user.address or '' }}"
        data-phone="{{ user.phone or '' }}"
        data-user-type="{{ user.user_type }}"
        data-is-active="{{ user.is_active }}"
        data-profile-picture="{{ user.profile_picture or '' }}"
        data-created-at="{{ user.created_at if user.created_at else '' }}"
        data-last-login="{{ user.last_login if user.last_login else 'Never' }}"
>
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        
                                        {% if current_user and user.id != current_user.id %}
                                            <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}" 
                                                  class="d-inline" 
                                                  onsubmit="return confirm('Are you sure you want to delete this user?')">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">No users found</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="user-avatar mb-3">
                            <img id="viewProfilePicture" src="" alt="Profile Picture" class="avatar-img" style="display: none;">
                            <div id="viewAvatarPlaceholder" class="avatar-placeholder">
                                <span id="viewAvatarInitial" class="avatar-initial"></span>
                            </div>
                        </div>
                        <h5 id="viewFullName" class="mb-1"></h5>
                        <p id="viewUsername" class="text-muted mb-0"></p>
                        <div class="mt-3">
                            <span id="viewRoleBadge" class="badge"></span>
                            <span id="viewStatusBadge" class="badge ms-1"></span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <table class="table table-borderless">
                            <tr>
                                <td width="30%"><strong>Email:</strong></td>
                                <td id="viewEmail"></td>
                            </tr>
                            <tr id="viewPhoneRow">
                                <td><strong>Phone:</strong></td>
                                <td id="viewPhone"></td>
                            </tr>
                            <tr id="viewAddressRow">
                                <td><strong>Address:</strong></td>
                                <td id="viewAddress"></td>
                            </tr>
                            <tr>
                                <td><strong>Created:</strong></td>
                                <td id="viewCreatedAt"></td>
                            </tr>
                            <tr id="viewLastLoginRow">
                                <td><strong>Last Login:</strong></td>
                                <td id="viewLastLogin"></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('create_user') }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" name="first_name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" name="last_name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Address</label>
                            <input type="text" name="address" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="text" name="phone" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Role</label>
                            <select name="user_type" class="form-select">
                                <option value="resident" selected>Resident</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Password</label>
                            <input type="password" name="password" class="form-control" placeholder="Optional">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" name="confirm_password" class="form-control" placeholder="Optional">
                        </div>
                    </div>
                    <div class="text-muted small mt-3">
                        If no password is set, a default one will be generated and can be changed later by the user.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="editUserForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name</label>
                            <input type="text" name="first_name" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name</label>
                            <input type="text" name="last_name" class="form-control" id="editLastName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-control" id="editUsername" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Address</label>
                            <input type="text" name="address" class="form-control" id="editAddress">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="text" name="phone" class="form-control" id="editPhone">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Role</label>
                            <select name="user_type" class="form-select" id="editUserType">
                                <option value="resident">Resident</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">New Password</label>
                            <div class="input-group">
                                <input type="password" name="password" id="editPassword" class="form-control" placeholder="Leave blank to keep current">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="#editPassword">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Confirm Password</label>
                            <div class="input-group">
                                <input type="password" name="confirm_password" id="editConfirmPassword" class="form-control" placeholder="Leave blank to keep current">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="#editConfirmPassword">
                                    <i class="bi bi-eye-slash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function () {
        var editModal = document.getElementById('editUserModal');
        if (editModal) {
            editModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                if (!button) return;

                var userId = button.getAttribute('data-user-id');
                var firstName = button.getAttribute('data-first-name') || '';
                var lastName = button.getAttribute('data-last-name') || '';
                var username = button.getAttribute('data-username') || '';
                var email = button.getAttribute('data-email') || '';
                var userType = button.getAttribute('data-user-type') || 'resident';
                var isActive = button.getAttribute('data-is-active') || 'false';

                var form = document.getElementById('editUserForm');
                
                // Set user ID in hidden field
                var userIdField = form.querySelector('input[name="user_id"]');
                if (userIdField) {
                    userIdField.value = userId;
                }
                
                // Populate form fields
                var firstNameField = document.getElementById('editFirstName');
                if (firstNameField) firstNameField.value = firstName;
                
                var lastNameField = document.getElementById('editLastName');
                if (lastNameField) lastNameField.value = lastName;
                
                var usernameField = document.getElementById('editUsername');
                if (usernameField) usernameField.value = username;
                
                var emailField = document.getElementById('editEmail');
                if (emailField) emailField.value = email;
                
                var userTypeField = document.getElementById('editUserType');
                if (userTypeField) {
                    userTypeField.value = userType;
                }
                
                var isActiveField = document.getElementById('editIsActive');
                if (isActiveField) {
                    isActiveField.checked = isActive === 'True' || isActive === 'true';
                }
                
                // Set form action
                if (form) {
                    form.action = "{{ url_for('edit_user', user_id=0) }}".replace('0', userId);
                }
            });
        }

        // Client-side highlight for search term
        var searchTerm = "{{ filters.search|default('') }}".trim().toLowerCase();
        if (searchTerm) {
            var wrapper = document.getElementById('userCardWrapper');
            if (wrapper) {
                var cards = wrapper.querySelectorAll('.user-card');
                cards.forEach(function (card) {
                    var text = card.textContent;
                    var lower = text.toLowerCase();
                    var idx = lower.indexOf(searchTerm);
                    if (idx !== -1) {
                        card.style.display = 'block';
                        card.style.opacity = '1';
                    } else {
                        card.style.display = 'none';
                        card.style.opacity = '0';
                    }
                });
                
                // Show "no users found" message if all cards are hidden
                var visibleCards = Array.from(cards).filter(function(card) {
                    return card.style.display !== 'none';
                });
                
                var noUsersMessage = document.querySelector('.no-users-message');
                if (!noUsersMessage) {
                    noUsersMessage = document.createElement('div');
                    noUsersMessage.className = 'no-users-message col-12';
                    noUsersMessage.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">No users found matching your search</p>
                        </div>
                    `;
                    wrapper.querySelector('#userCardContainer').appendChild(noUsersMessage);
                }
                
                if (visibleCards.length === 0) {
                    noUsersMessage.style.display = 'block';
                } else {
                    noUsersMessage.style.display = 'none';
                }
            }
        }
        
        // Handle View User Modal
        var viewUserModal = document.getElementById('viewUserModal');
        if (viewUserModal) {
            viewUserModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                
                // Get user data from button attributes
                var firstName = button.getAttribute('data-first-name');
                var lastName = button.getAttribute('data-last-name');
                var username = button.getAttribute('data-username');
                var email = button.getAttribute('data-email');
                var address = button.getAttribute('data-address');
                var phone = button.getAttribute('data-phone');
                var userType = button.getAttribute('data-user-type');
                var isActive = button.getAttribute('data-is-active') === 'true';
                var createdAt = button.getAttribute('data-created-at');
                var lastLogin = button.getAttribute('data-last-login');
                var profilePicture = button.getAttribute('data-profile-picture');
                
                // Set profile picture or default
                var profileImg = document.getElementById('viewProfilePicture');
                var avatarPlaceholder = document.getElementById('viewAvatarPlaceholder');
                var avatarInitial = document.getElementById('viewAvatarInitial');
                
                if (profilePicture) {
                    profileImg.src = '/static/uploads/profile_pics/' + profilePicture;
                    profileImg.style.display = 'block';
                    avatarPlaceholder.style.display = 'none';
                } else {
                    profileImg.src = '/static/img/default_profile.png';
                    profileImg.style.display = 'block';
                    avatarPlaceholder.style.display = 'none';
                }
                
                // Set user details
                document.getElementById('viewFullName').textContent = firstName + ' ' + lastName;
                document.getElementById('viewUsername').textContent = '@' + username;
                document.getElementById('viewEmail').textContent = email;
                
                // Handle optional fields
                if (phone) {
                    document.getElementById('viewPhoneRow').style.display = '';
                    document.getElementById('viewPhone').textContent = phone;
                } else {
                    document.getElementById('viewPhoneRow').style.display = 'none';
                }
                
                if (address) {
                    document.getElementById('viewAddressRow').style.display = '';
                    document.getElementById('viewAddress').textContent = address;
                } else {
                    document.getElementById('viewAddressRow').style.display = 'none';
                }
                
                if (lastLogin) {
                    document.getElementById('viewLastLoginRow').style.display = '';
                    document.getElementById('viewLastLogin').textContent = lastLogin;
                } else {
                    document.getElementById('viewLastLoginRow').style.display = 'none';
                }
                
                // Set badges
                var roleBadge = document.getElementById('viewRoleBadge');
                if (userType === 'admin') {
                    roleBadge.className = 'badge bg-danger';
                    roleBadge.textContent = 'Admin';
                } else {
                    roleBadge.className = 'badge bg-primary';
                    roleBadge.textContent = 'Resident';
                }
                
                var statusBadge = document.getElementById('viewStatusBadge');
                if (isActive) {
                    statusBadge.className = 'badge bg-success ms-1';
                    statusBadge.textContent = 'Active';
                } else {
                    statusBadge.className = 'badge bg-secondary ms-1';
                    statusBadge.textContent = 'Inactive';
                }
                
                // Set created date
                document.getElementById('viewCreatedAt').textContent = createdAt || 'N/A';
            });
        }
        
        // Function to toggle user status
        function toggleUserStatus(userId) {
            if (confirm('Are you sure you want to toggle this user\'s status?')) {
                fetch(`/toggle_user_status/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while toggling user status');
                });
            }
        }
    });

    // Toggle password visibility
    document.addEventListener('click', function(e) {
        if (e.target.closest('.toggle-password')) {
            const button = e.target.closest('.toggle-password');
            const targetId = button.getAttribute('data-target');
            const input = document.querySelector(targetId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            }
        }
    });
</script>
{% endblock %}
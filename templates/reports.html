{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-clipboard-data me-2"></i>Reports & Analytics</h1>
        <div>
            <button class="btn btn-outline-primary" onclick="exportReports()">
                <i class="bi bi-download me-1"></i> Export Reports
            </button>
            <button class="btn btn-primary" onclick="refreshReports()">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="totalUsers">0</h4>
                            <p class="mb-0">Total Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people-fill fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="totalConcerns">0</h4>
                            <p class="mb-0">Total Concerns</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle-fill fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="totalAnnouncements">0</h4>
                            <p class="mb-0">Announcements</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-megaphone-fill fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="totalEvents">0</h4>
                            <p class="mb-0">Events</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-calendar-event-fill fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Activity Overview</h5>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>User Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="userChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Reports -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Recent Concerns</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Status</th>
                                    <th>Reported By</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="concernsTable">
                                <tr>
                                    <td colspan="5" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-megaphone me-2"></i>Recent Announcements</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="announcementsTable">
                                <tr>
                                    <td colspan="4" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Activity Log -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Login Activity Log</h5>
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="loginFilter">
                            <option value="all">All Logins</option>
                            <option value="success">Successful</option>
                            <option value="failed">Failed</option>
                            <option value="admin">Admin Only</option>
                        </select>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearLoginLog()">
                            <i class="bi bi-trash me-1"></i> Clear Log
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Username</th>
                                    <th>User Type</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Date/Time</th>
                                </tr>
                            </thead>
                            <tbody id="loginTable">
                                <tr>
                                    <td colspan="6" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Login log pagination">
                        <ul class="pagination justify-content-center" id="loginPagination">
                            <!-- Pagination will be added dynamically -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- General Activity Log -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>General Activity Log</h5>
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="activityFilter">
                            <option value="all">All Activities</option>
                            <option value="login">Logins</option>
                            <option value="logout">Logouts</option>
                            <option value="concern_created">Concerns Created</option>
                            <option value="concern_status_updated">Concern Updates</option>
                            <option value="announcement_created">Announcements</option>
                            <option value="create_user">User Management</option>
                        </select>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearActivityLog()">
                            <i class="bi bi-trash me-1"></i> Clear Log
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>Date/Time</th>
                                </tr>
                            </thead>
                            <tbody id="activityTable">
                                <tr>
                                    <td colspan="4" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Activity log pagination">
                        <ul class="pagination justify-content-center" id="activityPagination">
                            <!-- Pagination will be added dynamically -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Export Reports</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Report Type</label>
                        <select class="form-select" id="exportType">
                            <option value="all">Complete Report</option>
                            <option value="users">Users Report</option>
                            <option value="concerns">Concerns Report</option>
                            <option value="announcements">Announcements Report</option>
                            <option value="activity">Activity Log</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date Range</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control" id="exportStartDate">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" id="exportEndDate">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="generateExport()">
                        <i class="bi bi-download me-1"></i> Generate Export
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let activityChart, userChart;
const itemsPerPage = 20;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize page variable
    window.currentPage = 1;
    
    // Initialize charts
    initializeCharts();
    
    // Load initial data
    loadReportsData();
    loadLoginLogs();
    loadActivityLog();
    
    // Set up event listeners
    document.getElementById('loginFilter').addEventListener('change', loadLoginLogs);
    document.getElementById('activityFilter').addEventListener('change', loadActivityLog);
});

// Initialize charts
function initializeCharts() {
    // Activity Chart
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    window.activityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Daily Activity',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // User Distribution Chart
    const userCtx = document.getElementById('userChart').getContext('2d');
    window.userChart = new Chart(userCtx, {
        type: 'doughnut',
        data: {
            labels: ['Admin', 'Resident'],
            datasets: [{
                data: [0, 0],
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Load reports data
async function loadReportsData() {
    try {
        const response = await fetch('/get_reports_data');
        const data = await response.json();
        
        if (data.error) {
            console.error('Error:', data.error);
            return;
        }

        // Update summary cards
        document.getElementById('totalUsers').textContent = data.total_users || 0;
        document.getElementById('totalConcerns').textContent = data.total_concerns || 0;
        document.getElementById('totalAnnouncements').textContent = data.total_announcements || 0;
        document.getElementById('totalEvents').textContent = data.total_events || 0;

        // Update charts
        updateActivityChart(data.daily_activity || {labels: [], data: []});
        updateUserChart(data.user_distribution || {labels: [], data: []});

        // Update tables
        updateConcernsTable(data.recent_concerns || []);
        updateAnnouncementsTable(data.recent_announcements || []);

    } catch (error) {
        console.error('Error loading reports data:', error);
    }
}

// Update activity chart
function updateActivityChart(activityData) {
    if (window.activityChart) {
        window.activityChart.data.labels = activityData.labels || [];
        window.activityChart.data.datasets[0].data = activityData.data || [];
        window.activityChart.update();
    }
}

// Update user distribution chart
function updateUserChart(userData) {
    if (window.userChart) {
        window.userChart.data.labels = userData.labels || [];
        window.userChart.data.datasets[0].data = userData.data || [];
        window.userChart.update();
    }
}

// Update concerns table
function updateConcernsTable(concerns) {
    const tbody = document.querySelector('#concernsTable tbody');
    tbody.innerHTML = '';
    
    concerns.forEach(concern => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${concern.id}</td>
            <td>${concern.title}</td>
            <td><span class="badge bg-${getStatusColor(concern.status)}">${concern.status}</span></td>
            <td>${concern.username}</td>
            <td>${formatDateTime(concern.created_at)}</td>
        `;
        tbody.appendChild(row);
    });
}

// Update announcements table
function updateAnnouncementsTable(announcements) {
    const tbody = document.querySelector('#announcementsTable tbody');
    tbody.innerHTML = '';
    
    announcements.forEach(announcement => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${announcement.id}</td>
            <td>${announcement.title}</td>
            <td>${announcement.author_name}</td>
            <td>${formatDateTime(announcement.created_at)}</td>
        `;
        tbody.appendChild(row);
    });
}

// Load login logs
async function loadLoginLogs() {
    try {
        const filter = document.getElementById('loginFilter').value;
        const page = window.currentPage || 1;
        const response = await fetch(`/get_login_logs?page=${page}&filter=${filter}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Error:', data.error);
            return;
        }
        
        updateLoginTable(data.login_logs || []);
        updateLoginPagination(data.total_pages || 1);
        
    } catch (error) {
        console.error('Error loading login logs:', error);
    }
}

// Update login table
function updateLoginTable(loginLogs) {
    const tbody = document.getElementById('loginTable');
    
    if (loginLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No login activities found</td></tr>';
        return;
    }
    
    tbody.innerHTML = loginLogs.map(log => `
        <tr>
            <td>${log.full_name}</td>
            <td>${log.username}</td>
            <td><span class="badge bg-${getUserTypeColor(log.user_type)}">${log.user_type}</span></td>
            <td><code>${log.ip_address}</code></td>
            <td><span class="badge bg-${log.login_status === 'success' ? 'success' : 'danger'}">${log.login_status}</span></td>
            <td>${formatDateTime(log.login_time)}</td>
        </tr>
    `).join('');
}

// Update login pagination
function updateLoginPagination(totalPages) {
    const pagination = document.getElementById('loginPagination');
    let html = '';
    
    for (let i = 1; i <= totalPages; i++) {
        html += `
            <li class="page-item ${i === (window.currentPage || 1) ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changeLoginPage(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    pagination.innerHTML = html;
}

// Change login page
function changeLoginPage(page) {
    window.currentPage = page;
    loadLoginLogs();
}

// Clear login log
async function clearLoginLog() {
    if (!confirm('Are you sure you want to clear the login log? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/clear_login_log', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            loadLoginLogs();
            alert('Login log cleared successfully');
        } else {
            alert('Error clearing login log');
        }
    } catch (error) {
        console.error('Error clearing login log:', error);
        alert('Error clearing login log');
    }
}

// Load activity log
async function loadActivityLog() {
    try {
        const filter = document.getElementById('activityFilter').value;
        const page = window.currentPage || 1;
        const response = await fetch(`/get_activity_log?page=${page}&filter=${filter}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Error:', data.error);
            return;
        }
        
        updateActivityTable(data.activities || []);
        updateActivityPagination(data.total_pages || 1);
        
    } catch (error) {
        console.error('Error loading activity log:', error);
    }
}

// Update activity table
function updateActivityTable(activities) {
    const tbody = document.getElementById('activityTable');
    
    if (activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No activities found</td></tr>';
        return;
    }
    
    tbody.innerHTML = activities.map(activity => `
        <tr>
            <td>${activity.user_name}</td>
            <td><span class="badge bg-${getActionColor(activity.action)}">${formatActionName(activity.action)}</span></td>
            <td>${activity.details}</td>
            <td>${formatDateTime(activity.created_at)}</td>
        </tr>
    `).join('');
}

// Update activity pagination
function updateActivityPagination(totalPages) {
    const pagination = document.getElementById('activityPagination');
    let html = '';
    
    for (let i = 1; i <= totalPages; i++) {
        html += `
            <li class="page-item ${i === (window.currentPage || 1) ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changeActivityPage(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    pagination.innerHTML = html;
}

// Change activity page
function changeActivityPage(page) {
    window.currentPage = page;
    loadActivityLog();
}

// Clear activity log
async function clearActivityLog() {
    if (!confirm('Are you sure you want to clear the activity log? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/clear_activity_log', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            loadActivityLog();
            alert('Activity log cleared successfully');
        } else {
            alert('Error clearing activity log');
        }
    } catch (error) {
        console.error('Error clearing activity log:', error);
        alert('Error clearing activity log');
    }
}

// Export reports
function exportReports() {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

// Generate export
function generateExport() {
    const type = document.getElementById('exportType').value;
    const format = document.getElementById('exportFormat').value;
    const startDate = document.getElementById('exportStartDate').value;
    const endDate = document.getElementById('exportEndDate').value;
    
    // Create export URL
    const params = new URLSearchParams({
        type: type,
        format: format,
        start_date: startDate,
        end_date: endDate
    });
    
    window.open(`/export_reports?${params.toString()}`, '_blank');
}

// Refresh reports
function refreshReports() {
    loadReportsData();
    loadLoginLogs();
    loadActivityLog();
}

// Helper functions
function formatActionName(action) {
    switch(action) {
        case 'login': return 'Login';
        case 'logout': return 'Logout';
        case 'concern_created': return 'Concern Created';
        case 'concern_status_updated': return 'Concern Updated';
        case 'announcement_created': return 'Announcement Created';
        case 'announcement_edited': return 'Announcement Edited';
        case 'announcement_deleted': return 'Announcement Deleted';
        case 'create_user': return 'User Created';
        case 'edit_user': return 'User Edited';
        case 'delete_user': return 'User Deleted';
        case 'update_status': return 'User Status Updated';
        case 'update_role': return 'User Role Updated';
        default: return action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
}

function getUserTypeColor(userType) {
    switch(userType) {
        case 'admin': return 'danger';
        case 'resident': return 'primary';
        case 'unknown': return 'secondary';
        default: return 'secondary';
    }
}

function getStatusColor(status) {
    switch(status) {
        case 'pending': return 'warning';
        case 'in_progress': return 'info';
        case 'resolved': return 'success';
        case 'rejected': return 'danger';
        default: return 'secondary';
    }
}

function getActionColor(action) {
    switch(action) {
        case 'login': return 'success';
        case 'logout': return 'secondary';
        case 'concern_created': return 'warning';
        case 'concern_status_updated': return 'info';
        case 'announcement_created': return 'primary';
        case 'announcement_edited': return 'info';
        case 'announcement_deleted': return 'danger';
        case 'create_user': return 'success';
        case 'edit_user': return 'warning';
        case 'delete_user': return 'danger';
        case 'update_status': return 'info';
        case 'update_role': return 'warning';
        default: return 'secondary';
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString();
}
</script>
{% endblock %}